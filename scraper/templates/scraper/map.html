{% extends 'scraper/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="header">
        <a href="{% url 'results' %}" class="back-btn">
            <i class="fa-solid fa-arrow-left"></i> Back to Results
        </a>
        <div class="logo">Subitissimo Map</div>
    </div>

    <div id="map" style="height: 600px; width: 100%; border-radius: 8px;"></div>
    
    <div id="loading-geo" class="alert alert-info mt-2" style="display:none;">
        Caricamento posizioni in corso... <span id="geo-progress">0</span>/<span>{{ items.count }}</span>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRS+765="
     crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<!-- Data for JS -->
{{ items_data|json_script:"items-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialize Map
    var map = L.map('map').setView([41.8719, 12.5674], 6);

    L.tileLayer('https://try.maps.overturemaps.org/tiles/2d-light/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; Overture Maps'
    }).addTo(map);
    // Alternatively fallback to OSM if Overture is slow/broken for you:
    // L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { ... }).addTo(map);

    // 2. Get Items from JSON Island
    var items = JSON.parse(document.getElementById('items-data').textContent);
    
    // 3. Add Markers
    var markers = L.markerClusterGroup ? L.markerClusterGroup() : L.layerGroup();
    
    var bounds = L.latLngBounds();
    var foundMarkers = 0;

    items.forEach(function(item) {
        if (item.lat && item.lon) {
            var marker = L.marker([item.lat, item.lon]);
            
            var content = `<b>${item.title}</b><br/>`;
            content += `Prezzo: â‚¬ ${item.price || '-'}<br/>`;
            if (item.image_url) {
                content += `<img src="${item.image_url}" style="max-width:100px; margin-top:5px; border-radius:4px;"><br/>`;
            }
            content += `<a href="${item.url}" target="_blank" style="display:inline-block; margin-top:5px; color:var(--primary);">Vedi su Subito</a>`;
            
            marker.bindPopup(content);
            markers.addLayer(marker);
            bounds.extend([item.lat, item.lon]);
            foundMarkers++;
        }
    });

    if (foundMarkers > 0) {
        map.addLayer(markers);
        map.fitBounds(bounds, {padding: [50, 50]});
    }
});
</script>
{% endblock %}
